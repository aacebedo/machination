##########################################################################
# Machination
# Copyright (c) 2014, Alexandre ACEBEDO, All rights reserved.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 3.0 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library.
##########################################################################

require 'yaml'
ENV['VAGRANT_DEFAULT_PROVIDER'] = "docker"

cwd = File.dirname(File.expand_path(__FILE__))
machine_config = YAML.load_file("#{cwd}/machine_instance_config.yml")
supportedProvisioners = ["Ansible"]
supportedProviders = ["Docker"]
supportedArchs = ["x64"]

name = "machination-"+cwd.split('/').last

if not machine_config["arch"]
	abort("Architecture is missing from the configuration file. Check the machine_instance_config file.")
end

if not machine_config["provider"]
	abort("Provider is missing from the configuration file. Check the machine_instance_config file.")
end

if not machine_config["provisioner"]
	abort("Provisioner is missing from the configuration file. Check the machine_instance_config file.")
end

if not machine_config["template"]
  abort("Template is missing from the configuration file. Check the machine_instance_config file.")
end

if not supportedProviders.include?(machine_config["provider"])
	abort("Given provider "+machine_config["provider"]+" is not supported. Supported providers are "+supportedProviders+". Check the machine_instance_config file.")
end

if not supportedProvisioners.include?(machine_config["provisioner"])
	abort("Given provisioner "+machine_config["provisioner"]+" is not supported. Supported provisioners are "+supportedProvisioners+". Check the machine_instance_config file.")
end

templateSplit = machine_config["template"].split("|")
if templateSplit.length != 2
  abort("Invalid template name (shall be <template_name>|<version>.")
end

Vagrant.configure("2") do |config|
  config.ssh.forward_agent = true
  config.vm.network "public_network"
  config.ssh.forward_x11 = true
  config.ssh.insert_key = false
  config.ssh.private_key_path = ["~/.ssh/id_rsa","~/.vagrant.d/insecure_private_key"]
  config.vm.hostname = name

  if machine_config["synced_folders"]
	  for f in machine_config["synced_folders"]
	  	if f["host_dir"] and f["guest_dir"]
		  	config.vm.synced_folder f["host_dir"], f["guest_dir"]
      end
	  end
  end
  if machine_config["provider"] == "Docker"
    imageName = "machination-"+templateSplit[0]+"-"+machine_config["arch"]+"-"+machine_config["os_version"]+"-"+machine_config["provisioner"]+"-"+templateSplit[1]
    imageName = imageName.downcase
    cmd = ` docker images | cut -d ' ' -f 1 | grep #{imageName}`
    imageNeedsToCreated = (cmd == "")
    config.vm.define name do |a|
      a.vm.provider "docker" do |d|
        if imageNeedsToCreated
          d.image = "aacebedo/ubuntu-"+machine_config["os_version"]+"-vagrant-"+machine_config["arch"]
  	    else
  	      d.image = imageName
        end
        d.name = name
        d.remains_running = true
        d.create_args = ["-t","-i"]
        d.privileged = true
        d.cmd = ["/sbin/init"]
        d.has_ssh = true
      end
    end
    config.vm.provision :host_shell,run: "always" do |host_shell|
      command = ""
      counter=0
      if ARGV[0] == "up"
        for i in machine_config["guest_interfaces"]
          counter+=1
          if machine_config["host_interface"] and i["ip_addr"] and i["mac_addr"]
            if i["hostname"]
              command += "pipework " + machine_config["host_interface"] + " -i eth" + counter.to_<s + " " + name + " " + i["hostname"] + " " + i["ip_addr"] + " " + i["mac_addr"] + ";"
            else
              command += "pipework " + machine_config["host_interface"] + " -i eth" + counter.to_s + " " + name + " " + name + " " + i["ip_addr"] + " " + i["mac_addr"] + ";"
            end
          else
            puts("An interface description is malformed. Check the machine_instance_config file.")
          end
        end
      end
      host_shell.inline = command
    end
    if(ARGV[0] != "ssh" and ARGV[0] != "infos" and ARGV[0] != "halt" and ARGV[0] != "destroy") and imageNeedsToCreated or ARGV[0] == "provision"
      puts("Docker image #{imageName} is not available yet. It will be committed.")
      if machine_config["provisioner"] == "Ansible"
        config.vm.provision :ansible do |ansible|
          playbookPath = File.join("provisioners","ansible","playbooks",templateSplit[0]+".playbook")
          if not File.exist?(playbookPath)
            abort("Ansible playbook file is missing ("+playbookPath+"). Check your instance.")
          end
          ENV['ANSIBLE_CONFIG'] = File.join(".","ansible.cfg")
          ansible.playbook = playbookPath
          ansible.sudo = true
          ansible.verbose = "v"
        end
      end
      config.vm.provision :host_shell,run: "always" do |host_shell|
        host_shell.inline = "docker commit #{name} #{imageName}"
      end
    end
  end
end
